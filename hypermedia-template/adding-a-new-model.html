<!doctype html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adding a New Model</title>
    <link rel="stylesheet" href="/HypermediaDocs/lib/bootstrap/dist/css/bootstrap-custom.css?linkver=20200216073111" type="text/css">
<link rel="stylesheet" href="/HypermediaDocs/lib/sidebar/css/simple-sidebar.css?linkver=20200216073111" type="text/css">
<link rel="stylesheet" href="/HypermediaDocs/lib/sidebar/css/sidemenu.css?linkver=20200216073111" type="text/css">
<link rel="stylesheet" href="/HypermediaDocs/lib/edity/css/layout.css?linkver=20200216073111" type="text/css">

</head>

<body>
    <nav class="navbar navbar-inverse navbar-fixed-top navbar-nomargin" data-hr-run="edity.theme.layouts.default">
        <a class="navbar-brand" href="#ToggleMenu" data-target="#wrapper" data-toggle="sidebar">
            <span class="sr-only">Toggle navigation</span>
            <span class="glyphicon glyphicon-menu-hamburger"></span>
        </a>
        <div class="navbar-header navbar-nowrap">
            <a class="navbar-brand" href="/HypermediaDocs/">Threax Hypermedia Framework and Architecture</a>
        </div>
    </nav>

    <div class="navbar-shadow-short"></div>
    <div class="navbar-spacer-short"></div>

    <div id="wrapper">
        <!-- Sidebar -->
        <div id="sidebar-wrapper" class="sidebar-with-navbar-short">
            <div class="mainTreeMenu" data-hr-controller="treeMenu" data-hr-config-urlroot="/HypermediaDocs/" data-hr-config-menu="/HypermediaDocs/menus/mainMenu.json" data-hr-config-scrollelement="#sidebar-wrapper" data-hr-model-component="sidebarMenuComponent" data-hr-config-treemenu-version="9E65631614F6C3D8CB2EE9055E5E46C5BF894820C0FEC1544CE51F5550B4D8FC">
                <ul class="sidebarMenu" data-hr-model="childItems" data-hr-model-component="sidebarMenuComponent">
                    <template data-hr-component="sidebarMenuComponent">
                        <li class="folder">
                            <div class="item" data-hr-on-click="toggleMenuItem" data-hr-toggle="current" data-hr-class-on="currentFolder"><span data-hr-toggle="children" class="glyphicon" data-hr-class-on="glyphicon-folder-open" data-hr-class-off="glyphicon-folder-close"></span> {{name}}</div>
                            <div class="children" data-hr-model="children" data-hr-model-component="sidebarMenuComponent" data-hr-toggle="children" data-hr-class-on="expanded" data-hr-style-off="display:none;"></div>
                        </li>
                    </template>
                    <template data-hr-variant="link">
                        <li class="link">
                            <a href="{{urlRoot}}{{link}}" target="{{target}}">
                                <div class="mainBlock" data-hr-toggle="current" data-hr-class-on="currentLink">
                                    {{name}}
                                </div>
                            </a>
                        </li>
                    </template>
                    <template data-hr-variant="root">
                        <div class="children" data-hr-model="children" data-hr-model-component="sidebarMenuComponent" data-hr-toggle="children" data-hr-class-on="expanded" data-hr-style-off="display:none;"></div>
                    </template>
                </ul>
            </div>
        </div>

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container">
                <div class="row">
                    <div class="col-md-12 pageContent">
                        <h1>Adding a New Model</h1>
<p>This tutorial assumes you have a new hypermedia project somewhere. It will describe how to add a new model type to a system that will have all crud operations, paged data access and a ui with search. To accomplish this we will use the threax-modelgen tool that comes installed with the template. All of the class types described below will be generated by this tool.</p>
<p>In the documentation below class names will be discussed as ModelClassName, the Model part will be uniquly named to your model.</p>
<h3>Model Classes</h3>
<p>The models in the system have 4 representations that we use to help keep things organized. With separate models it is easier to flow the data between them using Automapper and it makes it harder to leak data by accident.</p>
<ol>
	<li>Input Model - The input class for a particular model. Defines what the ui forms look like and what data the user can input. It is possible to have several kinds of input models for a particular system model depending on how users interact with your service. Query models to do search are also classified as Input Models.</li>
	<li>Entity Model - The model for entity framework. Has database type attributes and represents the class that repositories will work with directly.</li>
	<li>View Model - The output class for a particular model. This is what will be returned from the service to the caller. It will define the links that will be included in the model result.</li>
	<li>Query Model - This class defines how this particular model is queried. Search UIs can be built from these.</li>
</ol>
<h3>Work Classes</h3>
<p>Controller - The controller class for the model. By default does not do much but forward requests on to the repository classes, but it also handles permissions and other access properties.</p>
<p>Repository - The repository class does the actual work of connecting to the database and changing data. It will take in input models and return view models. There is a base class that can be used to make writing a basic crud repo easier, if it fits your data model. It will work great if you are designing your database from scratch, otherwise you might want to implement your own repository. In addition to the concrete repository you will get an interface version and a ModelRepositoryConfig class. This config class will be nested under the node for ModelRepository in Visual Studio. The config class is discovered automatically on app startup and registers the repository in the app dependency injection.</p>
<h3>Mapping Code</h3>
<p>In the Mappers folder you will see a class called ModelProfile. This class defines the automapper mappings between your various model classes. You can customize the profile further if you need to.</p>
<h3>Client Side</h3>
<p>The model generator will generate a HomeController parital class that links to your view. You can see these if you expand HomeController in the Controllers folder. They will be named HomeController.Model.cs. In addition you will get a Model.cshtml and Model.ts file in your Views/Home directory. Finally you will get a ModelCrudInjector.ts file in your Client/Libs folder. The typescript (.ts) files have most of their code commented out when they are first generated since you have to update the ServiceClient.ts file before these will compile. Since the app needs to compile to do this the code starts commented, you will then uncomment it after you update the client. This process is described below.</p>
<h2>Adding the Model</h2>
<p>Adding a new model has a few steps. First you must define a Schema for your model in the Model Schemas folder. You can do this with a JSON Schema in a .json file or using a class defined in your project to represent the model. Next you run the model generator to generate the classes for your model. Next you will run the ef database migration add tool to add a migration. Then you will run the app in setupdb mode. Next you will run the app in Update Client mode to update the client. Finally you will uncomment the typescript files and you will have a crud ui for your newly added model. These steps are described in detail below.</p>
<h3>Define a Schema Model</h3>
<p>First lets define a model schema for the data we want to add. In this case it will be a person class. In your app template add a new class to the ModelSchemas folder called Person. The name of the model class must match the file and it must be placed inside the ModelSchemas namespace within your app&#39;s root namespace. Otherwise the model generator will not be able to find it.</p>
<p>Inside that file paste the following contents:</p>
<p><code>using System;
	<br>using System.Collections.Generic;
	<br>using System.ComponentModel.DataAnnotations;
	<br>using System.Linq;
	<br>using System.Threading.Tasks;
	<br>using Threax.AspNetCore.Models;</code></p>
<p><code>namespace APP_NAMESPACE.ModelSchemas
	<br>{
	<br>&nbsp;&nbsp;&nbsp; [PluralName(&quot;People&quot;)]
	<br>&nbsp;&nbsp;&nbsp; public abstract class Person
	<br>&nbsp;&nbsp;&nbsp; {
	<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Required]
	<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [MaxLength(450)]
	<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public String First { get; set; }</code></p>
<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Required]
	<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [MaxLength(450)]
	<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public String Last { get; set; }</code></p>
<p><code>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public String Description { get; set; }
	<br>&nbsp;&nbsp;&nbsp; }
	<br>}</code></p>
<p>Replace <code>APP_NAMESPACE</code> with the real namespace of your app.</p>
<p>This defines a model called person with a first and last name and a description. The first and last name are marked as required. It also marks the plural name of the model to be People instead of the automatically generated Persons name. If just adding a &quot;s&quot; to the model name is ok you can erase the &quot;PlurarlName&quot; attribute to generate this automatically.</p>
<ol>
	<li>To generate the classes for this model click on the Package Manager Console in Visual Studio.
	<br><img class="fitImage" src="/HypermediaDocs/AutoUploads\354e2d3f-b648-4c6e-93c7-46973669aa0b.png"></li>
	<li>cd into your application&#39;s directory. By default the console in this window starts in the folder with the Solution.</li>
	<li>Next type in <code>dotnet threax-modelgen YourAppNamespace.ModelSchemas.Person</code> and the model generator will run and generate all of the Person classes for us. Be sure to replace YourAppNamespace with the namespace of your application. This should match the project name.</li>
	<li>After you do this the model classes described above have been created for the Person model. If you expand the InputModels, Controllers/Api, Repository or ViewModels folders you should see all of the new classes.</li>
</ol>
<h3>Create Migration</h3>
<p>The next step is to use entity framework to generate the database tables for us. In the same package manager console window type in the following:</p>
<p><code>dotnet ef migrations add people</code></p>
<p>Set the name appropriatly, here it is people since that is the table we added. This will add the migration.</p>
<h3>Apply Migration</h3>
<p>Next change the project mode to SetupDb and run the application. This will migrate and seed the database.</p>
<p>It is possible to seed custom data into the database by adding your seed code to the Seed function in the AppDatabaseServiceExtensions.cs file. Ideally check the repository for contents first, if it has some do not do anything, otherwise seed your values. We are not going to do this for the People model, but you can see how the Values table is seeded.</p>
<h3>Update Client</h3>
<p>Now change the project mode to Update Client and run it. This will update the Client\LIbs\ServiceClient.ts file to include the classes for the people model we just created.</p>
<h3>Uncommenting Client Side Code</h3>
<ol>
	<li>Open up Client\Libs\PersonCrudInjector.ts.</li>
	<li>Press ctrl + a to select all the code.</li>
	<li>Press ctrl + k then ctrl + u to uncomment all the code.</li>
	<li>Next open up Views\Home\People.ts.</li>
	<li>Select and uncomment all the code in this file.</li>
</ol>
<h3>Add a Link to the UI</h3>
<p>The last step is to add a link to the ui.</p>
<ol>
	<li>Open Views\Shared\_Layout.cshtml.</li>
	<li>Add the following to the navbar.
	<br><code>&lt;li class=&quot;nav-item&quot;&gt;&lt;a class=&quot;nav-link&quot; asp-area=&quot;&quot; asp-controller=&quot;Home&quot; asp-action=&quot;People&quot;&gt;People&lt;/a&gt;&lt;/li&gt;</code></li>
	<li>That will add the link to the ui controller so you can click it when you run the program.</li>
</ol>
<h3>Testing it Out</h3>
<p>Once all of the changes above are complete you should be able to edit people with a crud ui. Run the project and visit <a href="https://localhost:44321/People" target="_blank">https://localhost:44321/People</a>. You should get something like the following:</p>
<p><img class="fitImage" src="/HypermediaDocs/AutoUploads\f86fb2be-6aca-4e0d-b2a8-e861ba8def45.png"></p>
<p>Clicking add should show the add item dialog.</p>
<p><img class="fitImage" src="/HypermediaDocs/AutoUploads\04551b21-9217-452e-ad66-112de3e26a54.png"></p>
<p>Trying to save without adding anything should give some errors.</p>
<p><img class="fitImage" src="/HypermediaDocs/AutoUploads\6f57dd7c-aa75-4737-b322-0fbb67a20d99.png"></p>
<p>Entering some actual values should add the person to the database.</p>
<p><img class="fitImage" src="/HypermediaDocs/AutoUploads\2e167ef8-0d22-4249-9ebb-64c4f5d264da.png"></p>
<h3>Conclusion</h3>
<p>This shows what you get using the model generator. The model generator was introduced to reduce the effort of adding new data to an app. Before all of the classes that this generates needed to be written by hand or copied from the Values example. From this point you will customize your code as you need to to make your app&#39;s data work as you expect.</p>
<p>You can also change the data in your Json Schema and regenerate your models. You will want to repeat each step above if you update your data this way. Howver, note that if you have done any customizations to the code that was generated regenerating the model will override those changes. If you make sure to commit to git first you will be able to diff and bring your customizations back if you need to. Regenerating models to update them isn&#39;t really how the model generator is designed to work, its really more for getting you started with some basic code.</p>
                        <div class="footer"></div>
                    </div>
                </div>
                <div class="footer-padding"></div>
            </div>
        </div>
    </div>
    <script type="text/javascript" src="/HypermediaDocs/lib/polyfill.js?linkver=20200216073111"></script>
<script type="text/javascript" src="/HypermediaDocs/lib/tslib.js?linkver=20200216073111"></script>
<script type="text/javascript" src="/HypermediaDocs/lib/jquery/dist/jquery.min.js?linkver=20200216073111"></script>
<script type="text/javascript" src="/HypermediaDocs/lib/bootstrap/dist/js/bootstrap.min.js?linkver=20200216073111"></script>
<script type="text/javascript" src="/HypermediaDocs/lib/tsbin.prod.js?linkver=20200216073111"></script>
<script type="text/javascript" src="/HypermediaDocs/lib/hr-run.js?linkver=20200216073111"></script>

</body>

</html>